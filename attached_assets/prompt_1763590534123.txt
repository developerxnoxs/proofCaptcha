# PROMPT UNTUK IMPLEMENTASI FITUR CUSTOM SETTINGS LANJUTAN

## KONTEKS PROJECT
ProofCaptcha adalah sistem CAPTCHA dengan widget JavaScript (api.js) yang mendukung validasi domain, multiple challenge types, dan customizable API key settings. Sistem ini sudah memiliki:

1. **Widget Library**: `server/public/proofCaptcha/api.js` (4800+ lines)
2. **Backend API**: `server/routes.ts` dengan Express routes
3. **Database Schema**: `shared/schema.ts` dengan Drizzle ORM
4. **Security Settings**: Sudah ada 15+ fitur keamanan yang bisa dikustomisasi per API key

## FITUR YANG SUDAH ADA

### Security Settings (Sudah Implemented)
```typescript
// File: shared/schema.ts - securitySettingsSchema
{
  // Security Features
  antiDebugger: boolean,
  advancedFingerprinting: boolean,
  sessionBinding: boolean,
  csrfProtection: boolean,
  ipRateLimiting: boolean,
  automationDetection: boolean,
  behavioralAnalysis: boolean,
  riskAdaptiveDifficulty: boolean,
  
  // Blocking
  blockedIps: string[],
  blockedCountries: string[],
  
  // Performance
  proofOfWorkDifficulty: number (1-10),
  rateLimitWindowMs: number,
  rateLimitMaxRequests: number,
  
  // Timeouts
  challengeTimeoutMs: number,
  tokenExpiryMs: number,
  
  // Challenge Types
  enabledChallengeTypes: string[]
}
```

### Widget (api.js) Current Features
- Domain validation saat initialization
- Multiple challenge types: grid, jigsaw, gesture, upside_down, audio
- Proof-of-work dengan web workers
- Advanced fingerprinting
- Token expiry & challenge timeout
- Error handling & retry mechanism
- Theme support (light/dark)
- Multi-language support (en/id)

## TUGAS: IMPLEMENTASI FITUR CUSTOM SETTINGS BARU

Implementasikan fitur-fitur berikut dengan **PRIORITAS BERTAHAP**:

---

## PHASE 1: Widget UI/UX Control (HIGH PRIORITY) ‚≠ê‚≠ê‚≠ê

### 1.1 Widget Customization Settings
Tambahkan ke `securitySettingsSchema` di `shared/schema.ts`:

```typescript
widgetCustomization: z.object({
  // Language control
  autoDetectLanguage: z.boolean().default(true),
  defaultLanguage: z.enum(['en', 'id']).default('en'),
  
  // Branding
  showBranding: z.boolean().default(true),
  customLogoUrl: z.string().nullable().default(null),
  customBrandText: z.string().nullable().default(null),
  
  // Theme
  allowThemeSwitch: z.boolean().default(false),
  forceTheme: z.enum(['light', 'dark', 'auto']).default('auto'),
  
  // Size
  widgetSize: z.enum(['compact', 'normal', 'large']).default('normal'),
  
  // Animation
  disableAnimations: z.boolean().default(false),
  animationSpeed: z.enum(['slow', 'normal', 'fast']).default('normal'),
}).optional(),
```

### 1.2 Implementasi di Widget (api.js)
Lokasi: `ProofCaptchaWidget` class constructor & render method

**Yang perlu diubah:**
1. Load `widgetCustomization` dari security config (line ~2590)
2. Apply custom logo & brand text di footer (line ~1874-1878)
3. Apply theme control di render (line ~1849)
4. Apply size control dengan CSS classes baru
5. Apply animation settings dengan CSS variables

**Contoh implementasi:**
```javascript
// Di method generateChallenge, setelah load security config:
if (securityConfig.widgetCustomization) {
  const custom = securityConfig.widgetCustomization;
  
  // Language
  if (!custom.autoDetectLanguage && custom.defaultLanguage) {
    this.language = custom.defaultLanguage;
  }
  
  // Theme
  if (custom.forceTheme && custom.forceTheme !== 'auto') {
    this.theme = custom.forceTheme;
  }
  
  // Size
  if (custom.widgetSize) {
    this.widgetSize = custom.widgetSize;
  }
  
  // Animation
  if (custom.disableAnimations) {
    this.animationsEnabled = false;
  }
  if (custom.animationSpeed) {
    this.animationSpeed = custom.animationSpeed;
  }
}
```

### 1.3 CSS Updates
Tambahkan di `server/public/proofCaptcha/widget.css`:

```css
/* Widget sizes */
.proofcaptcha-widget.compact { 
  width: 260px; 
  font-size: 13px; 
}
.proofcaptcha-widget.normal { 
  width: 300px; 
  font-size: 14px; 
}
.proofcaptcha-widget.large { 
  width: 340px; 
  font-size: 15px; 
}

/* Animation speeds */
.proofcaptcha-widget.speed-slow { 
  --animation-duration: 0.6s; 
}
.proofcaptcha-widget.speed-normal { 
  --animation-duration: 0.3s; 
}
.proofcaptcha-widget.speed-fast { 
  --animation-duration: 0.15s; 
}

/* Disable animations */
.proofcaptcha-widget.no-animations * {
  animation: none !important;
  transition: none !important;
}
```

---

## PHASE 2: User Feedback Control (HIGH PRIORITY) ‚≠ê‚≠ê‚≠ê

### 2.1 Custom Messages Schema
```typescript
userFeedback: z.object({
  // Error messages
  customErrorMessages: z.object({
    timeout: z.string().nullable().default(null),
    expired: z.string().nullable().default(null),
    failed: z.string().nullable().default(null),
    blocked: z.string().nullable().default(null),
    countryBlocked: z.string().nullable().default(null),
  }).optional(),
  
  // Success
  customSuccessMessage: z.string().nullable().default(null),
  showComputationCount: z.boolean().default(true),
  
  // Loading
  customLoadingMessage: z.string().nullable().default(null),
  showProgressBar: z.boolean().default(false),
  
  // Audio feedback
  enableSoundEffects: z.boolean().default(false),
  successSoundUrl: z.string().nullable().default(null),
  errorSoundUrl: z.string().nullable().default(null),
}).optional(),
```

### 2.2 Implementasi di Widget
**Lokasi untuk diubah:**
1. `updateWidgetState()` method (line ~1909) - Apply custom messages
2. `handleChallengeTimeout()` (line ~2151) - Use custom timeout message
3. `handleTokenExpiry()` (line ~2182) - Use custom expired message
4. Success state (line ~1919-1944) - Use custom success message

**Contoh:**
```javascript
// Load custom messages
if (securityConfig.userFeedback) {
  this.customMessages = securityConfig.userFeedback.customErrorMessages || {};
  this.customSuccessMessage = securityConfig.userFeedback.customSuccessMessage;
  this.showComputationCount = securityConfig.userFeedback.showComputationCount;
}

// Apply di updateWidgetState
if (this.status === 'error') {
  const defaultMessage = this.errorMessage || 'Verification failed';
  const customMessage = this.customMessages[this.errorType] || defaultMessage;
  text.innerHTML = `<div class="proofcaptcha-text-status">${customMessage}</div>`;
}
```

---

## PHASE 3: Challenge Behavior Control (MEDIUM PRIORITY) ‚≠ê‚≠ê

### 3.1 Behavior Settings Schema
```typescript
challengeBehavior: z.object({
  // Auto-retry
  autoRetryOnFail: z.boolean().default(true),
  maxAutoRetries: z.number().min(0).max(5).default(3),
  retryDelayMs: z.number().min(200).max(3000).default(800),
  
  // Challenge selection
  challengeSelectionMode: z.enum(['random', 'sequential', 'risk-based']).default('risk-based'),
  preferredChallengeType: z.enum(['grid', 'jigsaw', 'gesture', 'upside_down', 'audio']).nullable().default(null),
  
  // Difficulty progression
  enableDifficultyProgression: z.boolean().default(true),
  maxDifficultyLevel: z.number().min(1).max(10).default(7),
  
  // Skip for trusted users
  allowSkipForTrustedFingerprints: z.boolean().default(false),
  trustThresholdDays: z.number().min(1).max(365).default(30),
}).optional(),
```

### 3.2 Implementasi
**Lokasi:**
1. Auto-retry logic sudah ada di verification methods (line ~3893-3910)
2. Challenge selection di `generateChallenge` method (line ~2390)
3. Difficulty progression perlu tracking di server-side

---

## PHASE 4: Performance & Optimization (MEDIUM PRIORITY) ‚≠ê‚≠ê

### 4.1 Performance Schema
```typescript
performance: z.object({
  // Preloading
  preloadChallenges: z.boolean().default(false),
  prefetchAssets: z.boolean().default(true),
  
  // Caching
  cacheValidTokens: z.boolean().default(false),
  tokenCacheDurationMs: z.number().min(60000).max(900000).default(300000),
  
  // Network
  enableCompression: z.boolean().default(true),
  useCDN: z.boolean().default(false),
  cdnUrl: z.string().nullable().default(null),
  
  // Workers
  maxWorkerThreads: z.number().min(1).max(8).default(4),
  workerFallbackEnabled: z.boolean().default(true),
}).optional(),
```

---

## PHASE 5: Privacy & Accessibility (LOW PRIORITY) ‚≠ê

### 5.1 Privacy Schema
```typescript
privacy: z.object({
  // GDPR
  enableGDPRMode: z.boolean().default(false),
  requireExplicitConsent: z.boolean().default(false),
  
  // Data retention
  anonymizeFingerprints: z.boolean().default(false),
  deleteDataAfterDays: z.number().min(7).max(365).default(90),
  
  // Links
  showPrivacyLink: z.boolean().default(true),
  customPrivacyUrl: z.string().nullable().default(null),
  customTermsUrl: z.string().nullable().default(null),
  
  // Minimal mode
  minimalDataMode: z.boolean().default(false),
}).optional(),
```

### 5.2 Accessibility Schema
```typescript
accessibility: z.object({
  // Screen reader
  enableAriaLabels: z.boolean().default(true),
  
  // Keyboard
  enableKeyboardNavigation: z.boolean().default(true),
  
  // Visual
  enableHighContrastMode: z.boolean().default(false),
  
  // Alternative challenges
  alwaysShowAudioChallenge: z.boolean().default(false),
  enableTextBasedChallenge: z.boolean().default(false),
}).optional(),
```

---

## IMPLEMENTATION GUIDELINES

### 1. File Structure
```
shared/schema.ts
  ‚îî‚îÄ Update securitySettingsSchema (add new fields)
  ‚îî‚îÄ Update DEFAULT_SECURITY_SETTINGS

server/routes.ts
  ‚îî‚îÄ Return new settings in minimalSecurityConfig (line ~3990)
  
server/public/proofCaptcha/api.js
  ‚îî‚îÄ Load settings in generateChallenge (line ~2580)
  ‚îî‚îÄ Apply settings in constructor & render
  ‚îî‚îÄ Update updateWidgetState for custom messages
  
server/public/proofCaptcha/widget.css
  ‚îî‚îÄ Add new CSS classes for customization
```

### 2. Important Notes

**JANGAN LUPA:**
1. ‚úÖ Update `DEFAULT_SECURITY_SETTINGS` di `shared/schema.ts`
2. ‚úÖ Return settings di `minimalSecurityConfig` (routes.ts line ~3992)
3. ‚úÖ Load settings di widget setelah challenge generation
4. ‚úÖ Test dengan multiple API keys
5. ‚úÖ Validate settings server-side

**SECURITY CONCERNS:**
- Settings harus di-load dari server (JANGAN biarkan client override)
- Validate semua input di schema
- Sanitize custom URLs untuk XSS prevention
- Custom messages harus di-escape HTML

### 3. Testing Checklist

Setelah implementasi, test:
- [ ] Default settings tetap bekerja (backward compatibility)
- [ ] Custom branding muncul dengan benar
- [ ] Theme control berfungsi
- [ ] Widget size changes correctly
- [ ] Custom error messages tampil
- [ ] Animation settings work
- [ ] Performance settings improve load time
- [ ] Accessibility features functional

### 4. Migration Strategy

Karena ini **ADDITIVE CHANGES** (menambah field baru), tidak perlu migration. Tapi:
1. Semua field harus `.optional()` atau `.default(value)`
2. Existing API keys tanpa settings akan use DEFAULT_SECURITY_SETTINGS
3. Widget backward compatible dengan API keys lama

---

## PRIORITAS IMPLEMENTASI

### Quick Win (1-2 jam):
1. **Widget Customization** (branding, theme, size)
2. **Custom Error Messages**

### Medium (2-4 jam):
3. **Challenge Behavior Control**
4. **Performance Settings** (caching, preloading)

### Advanced (4+ jam):
5. **Privacy & Compliance**
6. **Accessibility Features**

---

## DELIVERY EXPECTATIONS

Setelah implementasi Phase 1 & 2, developer harus bisa:
1. ‚úÖ Set custom logo & brand text di dashboard
2. ‚úÖ Control widget theme & size
3. ‚úÖ Customize semua error messages
4. ‚úÖ Enable/disable animations
5. ‚úÖ Control language behavior

Test dengan cara:
1. Buat API key baru di dashboard
2. Set custom settings (contoh: custom logo, theme dark, custom error messages)
3. Load widget dengan API key tersebut
4. Verify settings diterapkan dengan benar

---

## CONTACT & CONTEXT

**Existing Architecture:**
- Fullstack JavaScript (Express + React)
- Database: PostgreSQL dengan Drizzle ORM
- Widget: Vanilla JS (no framework)
- CSS: Custom CSS (no Tailwind di widget)

**Key Files:**
- `shared/schema.ts` - Database schema & types
- `server/routes.ts` - API routes (line 3900+ untuk challenge generation)
- `server/public/proofCaptcha/api.js` - Widget library
- `server/public/proofCaptcha/widget.css` - Widget styles

**Development Mode:**
- Server runs on port 5000
- Widget auto-reloads on changes
- Use demo API key: `pk_ab6c4ac2c8976668e6d92fe401386cae18df4c9b4f5193cb140266f6d9546f1c`

Good luck! üöÄ
