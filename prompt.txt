# ðŸŽ¯ Prompt: Founder Management & Widget Control Enhancement

## Project Context
ProofCaptcha adalah sistem CAPTCHA berbasis proof-of-work dengan dashboard React, Express backend, dan embeddable JavaScript widget. Founder dashboard saat ini sudah memiliki basic monitoring (system health, top developers, API keys overview, activity log).

## Implementation Goals

### **PHASE 1: Founder Widget Control System**
Implementasikan kontrol penuh founder terhadap `server/public/proofCaptcha/api.js` (widget configuration):

#### Backend Requirements:
1. **Widget Configuration Management**
   - Endpoint `GET /api/founder/widget-config` - Get current global widget configuration
   - Endpoint `PUT /api/founder/widget-config` - Update widget configuration globally
   - Endpoint `GET /api/founder/widget-versions` - List all widget versions with rollback capability
   - Add `widget_config` table to database schema:
     ```typescript
     {
       id: string (primary key)
       version: string (e.g., "1.0.3")
       cdnUrl: string | null (custom CDN override)
       forceUpdate: boolean (force all sites to use latest)
       globalSettings: json ({
         minLoadDelay: number,
         maxRetries: number,
         timeoutMs: number,
         debugMode: boolean,
         customStyles: string | null (CSS override)
       })
       isActive: boolean
       createdAt: timestamp
       updatedAt: timestamp
     }
     ```

2. **Widget Distribution Control**
   - Endpoint `POST /api/founder/widget/publish` - Publish new widget version
   - Endpoint `POST /api/founder/widget/rollback/:versionId` - Rollback to previous version
   - Support for CDN override (allow founder to serve widget from custom CDN)
   - Widget versioning with automatic backup before updates

3. **Real-time Widget Monitoring**
   - Endpoint `GET /api/founder/widget-stats` - Get widget load statistics:
     - Total loads per day/hour
     - Average load time
     - Error rate by browser/version
     - Geographic distribution of widget loads
   - Track widget errors in new `widget_errors` table

#### Frontend Requirements:
1. **Widget Control Page** (`/founder/widget-control`)
   - Live widget preview with hot-reload
   - Code editor untuk edit widget configuration
   - Version history dengan diff viewer
   - Publish/rollback buttons dengan confirmation
   - CDN URL configuration
   - Global settings form (debug mode, timeouts, retries, custom CSS)

2. **Widget Analytics Dashboard**
   - Real-time widget load chart (last 24h)
   - Error rate monitoring dengan error details
   - Browser/device breakdown
   - Geographic heatmap

---

### **PHASE 2: Advanced Developer Management**

#### Backend:
1. **Developer Account Control**
   - Endpoint `PUT /api/founder/developers/:id/suspend` - Suspend developer account
   - Endpoint `PUT /api/founder/developers/:id/activate` - Activate developer account
   - Endpoint `DELETE /api/founder/developers/:id` - Soft delete developer (mark as deleted, don't remove data)
   - Add `status` field to developers table: 'active' | 'suspended' | 'deleted'
   - Add `suspensionReason` text field for audit trail

2. **Usage Quotas & Limits**
   - Add `quotas` table:
     ```typescript
     {
       id: string
       developerId: string
       type: 'daily' | 'monthly' | 'total'
       maxVerifications: number
       currentUsage: number
       resetAt: timestamp
       createdAt: timestamp
     }
     ```
   - Endpoint `PUT /api/founder/developers/:id/quota` - Set/update quota
   - Auto-increment quota usage on each verification
   - Block verifications when quota exceeded

3. **Developer Audit Log**
   - Create `developer_audit_log` table:
     ```typescript
     {
       id: string
       developerId: string
       action: string (e.g., 'login', 'api_key_created', 'settings_updated')
       ipAddress: string
       metadata: json
       timestamp: timestamp
     }
     ```
   - Endpoint `GET /api/founder/developers/:id/audit-log` - Get developer's complete audit trail
   - Auto-log all developer actions (login, API key CRUD, settings changes)

#### Frontend:
1. **Developer Management Page** (`/founder/developers`)
   - Searchable/filterable table of all developers
   - Bulk actions: suspend, activate, export
   - Individual developer detail modal showing:
     - Profile info
     - API keys list
     - Usage statistics
     - Quota settings with edit capability
     - Audit log timeline
     - Suspend/Delete buttons dengan confirmation

---

### **PHASE 3: Security & Compliance Tools**

#### Backend:
1. **IP Management System**
   - Create `ip_rules` table:
     ```typescript
     {
       id: string
       ipAddress: string
       type: 'whitelist' | 'blacklist'
       reason: string
       expiresAt: timestamp | null
       createdBy: string (founder id)
       createdAt: timestamp
     }
     ```
   - Endpoint `POST /api/founder/ip-rules` - Add IP rule
   - Endpoint `DELETE /api/founder/ip-rules/:id` - Remove IP rule
   - Endpoint `GET /api/founder/ip-rules` - List all rules
   - Apply rules to all verification attempts

2. **Security Events Dashboard**
   - Create `security_events` table:
     ```typescript
     {
       id: string
       type: 'failed_verification' | 'rate_limit_hit' | 'automation_detected' | 'suspicious_pattern'
       severity: 'low' | 'medium' | 'high' | 'critical'
       ipAddress: string
       apiKeyId: string | null
       metadata: json
       timestamp: timestamp
     }
     ```
   - Endpoint `GET /api/founder/security-events` - Get events with filtering
   - Auto-log security events during verification process
   - Aggregate events untuk pattern detection

#### Frontend:
1. **IP Management Page** (`/founder/ip-management`)
   - Dual tables: Whitelist & Blacklist
   - Add IP form dengan reason & expiry
   - Bulk import from CSV
   - Search & filter capabilities

2. **Security Events Page** (`/founder/security`)
   - Real-time event feed dengan severity badges
   - Filtering by type, severity, date range
   - Quick action buttons (block IP, suspend developer)
   - Event detail modal dengan full metadata

---

### **PHASE 4: Analytics & Reporting**

#### Backend:
1. **Custom Date Range Analytics**
   - Extend existing analytics endpoints dengan `?startDate=&endDate=` query params
   - Endpoint `GET /api/founder/analytics/custom` - Custom analytics dengan date range
   
2. **Export Functionality**
   - Endpoint `GET /api/founder/export/analytics` - Export analytics as CSV/JSON
   - Endpoint `GET /api/founder/export/developers` - Export developer list
   - Endpoint `GET /api/founder/export/verifications` - Export verifications data
   - Use streaming untuk large datasets

3. **Automated Reports**
   - Create `scheduled_reports` table:
     ```typescript
     {
       id: string
       reportType: 'weekly' | 'monthly'
       recipients: string[] (email addresses)
       isActive: boolean
       lastSentAt: timestamp | null
       createdAt: timestamp
     }
     ```
   - Endpoint `POST /api/founder/reports/schedule` - Schedule report
   - Cron job untuk generate dan email reports

#### Frontend:
1. **Analytics Page Enhancements** (`/founder/analytics`)
   - Date range picker (today, yesterday, last 7 days, last 30 days, custom)
   - Export buttons (CSV, JSON) untuk all data
   - Historical trend charts (line charts showing success rate, avg solve time over time)

2. **Reports Configuration** (`/founder/reports`)
   - Schedule weekly/monthly reports
   - Select report recipients
   - Preview report format
   - Manual trigger untuk immediate report generation

---

### **PHASE 5: Real-time Monitoring & Alerts**

#### Backend:
1. **WebSocket Real-time Dashboard**
   - Extend existing chat WebSocket untuk include system metrics
   - Broadcast real-time verification events ke founder clients
   - Endpoint `GET /api/founder/live-stats` - SSE stream untuk live updates

2. **Alert System**
   - Create `alert_rules` table:
     ```typescript
     {
       id: string
       metric: 'success_rate' | 'avg_solve_time' | 'verification_count'
       operator: 'below' | 'above'
       threshold: number
       notification: 'email' | 'webhook' | 'both'
       webhookUrl: string | null
       isActive: boolean
       lastTriggeredAt: timestamp | null
     }
     ```
   - Endpoint `POST /api/founder/alerts` - Create alert rule
   - Background job untuk check metrics dan trigger alerts
   - Send email via nodemailer atau POST ke webhook

#### Frontend:
1. **Live Dashboard** (`/founder/live`)
   - Real-time verification feed (WebSocket-based)
   - Live metrics updating every second
   - Map visualization showing active verifications globally
   
2. **Alert Configuration** (`/founder/alerts`)
   - Create/edit/delete alert rules
   - Test alert functionality
   - Alert history dengan timestamps

---

## Technical Requirements

### Database:
- Add all new tables to `shared/schema.ts` dengan proper Drizzle schema
- Create Drizzle migrations untuk all new tables
- Use proper indexes untuk performance (especially on timestamp & foreign key columns)

### Authentication:
- All new endpoints MUST use `requireFounder` middleware
- No developer should access founder endpoints (return 403)

### Performance:
- Use Map-based aggregation (O(n) not O(nÂ²)) untuk all data processing
- Implement pagination untuk large datasets
- Add Redis caching jika diperlukan untuk frequently-accessed data

### Security:
- Validate all inputs dengan Zod schemas
- Sanitize user inputs to prevent XSS/SQL injection
- Rate limit founder endpoints appropriately
- Log all founder actions untuk audit trail

### Frontend:
- Use TanStack Query untuk all API calls
- Show loading states dan error boundaries
- Add data-testid attributes ke all interactive elements
- Follow existing shadcn/ui component patterns
- Responsive design untuk mobile/tablet

### Widget Control Specifics:
- `api.js` configuration should be hot-reloadable tanpa browser refresh
- Support A/B testing (serve different widget versions to different percentages)
- Add widget error tracking yang sends errors back to backend
- Implement widget kill switch (disable all widgets globally in emergency)

---

## Implementation Priority

**HIGH PRIORITY:**
1. Founder Widget Control (PHASE 1) - Most critical untuk full system control
2. Developer Management & Quotas (PHASE 2) - Essential untuk scaling
3. Security Events & IP Management (PHASE 3) - Important untuk security

**MEDIUM PRIORITY:**
4. Analytics & Reporting (PHASE 4) - Nice to have untuk insights
5. Real-time Monitoring (PHASE 5) - Advanced feature

---

## Success Criteria

âœ… Founder can edit, publish, and rollback widget versions from dashboard  
âœ… Founder can suspend/activate developers and set usage quotas  
âœ… Founder can whitelist/blacklist IPs dengan expiry dates  
âœ… Founder can view security events dan export data  
âœ… Founder can schedule automated reports  
âœ… All endpoints are performant (< 500ms response time)  
âœ… All UI components follow existing design patterns  
âœ… Database migrations run successfully  
âœ… No breaking changes to existing functionality  

---

**Start dengan PHASE 1 (Founder Widget Control) terlebih dahulu, karena ini adalah highest priority feature yang memberikan founder kontrol penuh terhadap widget.**
